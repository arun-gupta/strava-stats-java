<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Strava Stats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Chart.js data labels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        /* Reduce pie chart size to 50% and center it */
        .chart-half {
            max-width: 50%;
            margin: 0 auto;
        }
        .chart-half canvas {
            width: 100% !important; /* let the container control actual width */
            height: auto !important;
        }
        /* Workout heatmap timeline */
        .timeline-wrapper {
            border: 1px solid #eee;
            border-radius: .5rem;
            padding: .5rem .75rem;
            overflow-x: auto;
            white-space: nowrap;
            background: #fff;
        }
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(14px, 14px));
            gap: 3px;
            max-width: 100%;
            border: 1px solid #eee;
            border-radius: .5rem;
            padding: .75rem;
            background: #fff;
            justify-content: start;
        }
        .day-box {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin: 2px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .day-cell {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .lvl-0 { background: #f2f2f2; }
        .lvl-1 { background: #ffe0b2; } /* < 1h or < 3mi */
        .lvl-2 { background: #ffb74d; } /* 1h - 2h or 3-6mi */
        .lvl-3 { background: #fb8c00; } /* 2h+ or 6-10mi */
        .lvl-4 { background: #e65100; } /* 10mi+ */
        .legend-item { display: inline-flex; align-items: center; margin-right: 12px; }
        .legend-swatch { width: 14px; height: 14px; border-radius:3px; display:inline-block; margin-right:6px; border:1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">Strava Stats</a>
            <div class="d-flex align-items-center ms-auto">
                <span class="navbar-text text-white me-3" th:if="${name}">
                    Welcome, <span th:text="${name}"></span>
                </span>
                <a href="https://github.com/arun-gupta/strava-stats-java" target="_blank" rel="noopener noreferrer"
                   class="text-white" title="View on GitHub" style="text-decoration: none;">
                    <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" style="fill: currentColor;">
                        <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path>
                    </svg>
                </a>
            </div>
        </div>
    </nav>

    <!-- Loading Spinner -->
    <div id="globalLoadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="z-index: 9999; display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Error Toast Container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="errorToastMessage">
                    An error occurred. Please try again.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="container mt-4">

        <!-- Date Range Filter -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="btn-group" role="group" id="quickPickGroup">
                                    <button type="button" id="btnLast7" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(7, 'btnLast7')">Last 7 Days</button>
                                    <button type="button" id="btnLast30" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(30, 'btnLast30')">Last 30 Days</button>
                                    <button type="button" id="btnLast90" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(90, 'btnLast90')">Last 90 Days</button>
                                    <button type="button" id="btnLast180" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(180, 'btnLast180')">Last 6 Months</button>
                                    <button type="button" id="btnYTD" class="btn btn-outline-secondary btn-sm" onclick="setDateRangeYTD('btnYTD')">YTD</button>
                                    <button type="button" id="btnAllTime" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(0, 'btnAllTime')">All Time</button>
                                    <button type="button" id="btnCustom" class="btn btn-outline-secondary btn-sm" onclick="showCustomRange('btnCustom')">Custom</button>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="customDateRow" style="display:none;">
                            <div class="col-md-3">
                                <label for="afterDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="afterDate" oninput="validateCustomRange()">
                            </div>
                            <div class="col-md-3">
                                <label for="beforeDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="beforeDate" oninput="validateCustomRange()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary d-block" id="applyCustomBtn" onclick="loadAllData()">Apply Filter</button>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <div class="text-danger small" id="customRangeError" role="alert" style="display:none;">Start date cannot be after end date.</div>
                            </div>
                        </div>
                        <div class="row mt-3" id="dateRangeDisplay" style="display:none;">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body py-2">
                                        <div class="row text-center">
                                            <div class="col-md-4 border-end">
                                                <small class="text-muted d-block">Date Range</small>
                                                <strong><span id="displayStartDate"></span> to <span id="displayEndDate"></span></strong>
                                                <small class="text-muted d-block">(<span id="displayTotalDays"></span> days)</small>
                                            </div>
                                            <div class="col-md-4 border-end">
                                                <small class="text-muted d-block">Activities</small>
                                                <strong class="fs-4 d-block"><span id="displayTotalActivities"></span></strong>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted d-block">Total Moving Time</small>
                                                <strong class="fs-4 d-block"><span id="displayTotalMovingTime"></span></strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="statsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="activity-count-tab" data-bs-toggle="tab"
                        data-bs-target="#activity-count" type="button" role="tab">
                    üìä Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="time-dist-tab" data-bs-toggle="tab"
                        data-bs-target="#time-dist" type="button" role="tab">
                    ‚è±Ô∏è Duration
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="streaks-tab" data-bs-toggle="tab"
                        data-bs-target="#streaks" type="button" role="tab">
                    üî• Heatmap
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trends-tab" data-bs-toggle="tab"
                        data-bs-target="#trends" type="button" role="tab">
                    üìà Trends
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="run-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#run-stats" type="button" role="tab">
                    üèÉ Running Stats
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3" id="statsTabContent">
            <!-- Overview -->
            <div class="tab-pane fade show active" id="activity-count" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Overview</h5>
                        <div class="chart-half">
                            <canvas id="activityCountChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Distribution -->
            <div class="tab-pane fade" id="time-dist" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Duration</h5>
                        <div class="chart-half">
                            <canvas id="timeDistChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Heatmap (Combined) -->
            <div class="tab-pane fade" id="streaks" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h5 class="card-title mb-0">Heatmap</h5>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Streak toggle">
                                <input type="radio" class="btn-check" name="streakMode" id="streakModeWorkout" autocomplete="off" checked>
                                <label class="btn btn-outline-secondary" for="streakModeWorkout">All Activities</label>
                                <input type="radio" class="btn-check" name="streakMode" id="streakModeRunning" autocomplete="off">
                                <label class="btn btn-outline-secondary" for="streakModeRunning">Running</label>
                            </div>
                        </div>

                        <!-- Workout Heatmap Section -->
                        <section id="streaks-workout-section">
                            <p class="text-muted small mb-2">Tracks all your activities (running, cycling, workouts, etc.) and measures consecutive days with at least one activity.</p>
                            <div class="d-flex justify-content-end align-items-center small text-muted mb-2">
                                <div class="legend-item"><span class="legend-swatch lvl-0"></span>No Activity</div>
                                <div class="legend-item"><span class="legend-swatch lvl-1"></span>< 1h</div>
                                <div class="legend-item"><span class="legend-swatch lvl-2"></span>1‚Äì2h</div>
                                <div class="legend-item"><span class="legend-swatch lvl-3"></span>2h+</div>
                            </div>
                            <div id="workoutTimeline" class="heatmap-grid mb-3"></div>
                            <div class="row text-center" id="streakCounters">
                                <div class="col-6 col-md-2 mb-2">
                                    <div class="h3 mb-0" id="workoutDays">0</div>
                                    <div class="text-muted small">Workout Days</div>
                                </div>
                                <div class="col-6 col-md-2 mb-2">
                                    <div class="h3 mb-0" id="missedDays">0</div>
                                    <div class="text-muted small">Missed Days</div>
                                </div>
                                <div class="col-6 col-md-2 mb-2">
                                    <div class="h3 mb-0" id="currentStreak">0</div>
                                    <div class="text-muted small">Current Streak</div>
                                </div>
                                <div class="col-6 col-md-2 mb-2">
                                    <div class="h3 mb-0" id="daysSinceLast">0</div>
                                    <div class="text-muted small">Days Since Last</div>
                                </div>
                                <div class="col-6 col-md-2 mb-2">
                                    <div class="h3 mb-0" id="longestGap">0</div>
                                    <div class="text-muted small">Longest Gap</div>
                                </div>
                                <div class="col-6 col-md-2 mb-2">
                                    <div class="h3 mb-0" id="totalGapDays">0</div>
                                    <div class="text-muted small">Total Gap Days</div>
                                </div>
                            </div>
                            <p class="mt-2" id="consistencyMsg"></p>
                            <div class="mt-3" id="showGapDetailsContainer" style="display: none;">
                                <button class="btn btn-sm btn-outline-primary" onclick="toggleGapDetails()">
                                    <span id="gapDetailsToggleText">Show Gap Details</span>
                                </button>
                            </div>
                            <div class="mt-3" id="gapDetailsSection" style="display: none;">
                                <div class="alert alert-warning">
                                    <h6 class="alert-heading">Missed Days:</h6>
                                    <div id="gapDetailsList"></div>
                                </div>
                            </div>
                        </section>

                        <!-- Running Heatmap Section -->
                        <section id="streaks-running-section" style="display:none;">
                            <p class="text-muted small mb-2">Tracks your running activities, showing daily mileage with color-coded intensity.</p>
                            <div class="d-flex justify-content-end align-items-center small text-muted mb-2">
                                <div class="legend-item"><span class="legend-swatch lvl-0"></span>Non-Running</div>
                                <div class="legend-item"><span class="legend-swatch lvl-1"></span>Easy</div>
                                <div class="legend-item"><span class="legend-swatch lvl-2"></span>Moderate</div>
                                <div class="legend-item"><span class="legend-swatch lvl-3"></span>Big Day</div>
                            </div>
                            <div id="runningHeatmap" class="heatmap-grid mb-3"></div>
                            <div class="row text-center" id="runningStats">
                                <div class="col-6 col-md-3 mb-2">
                                    <div class="h3 mb-0" id="runningDays">0</div>
                                    <div class="text-muted small">Running Days</div>
                                </div>
                                <div class="col-6 col-md-3 mb-2">
                                    <div class="h3 mb-0" id="nonRunningDays">0</div>
                                    <div class="text-muted small">Non-Running Days</div>
                                </div>
                                <div class="col-6 col-md-3 mb-2">
                                    <div class="h3 mb-0" id="currentRunStreak">0</div>
                                    <div class="text-muted small">Current Streak</div>
                                </div>
                                <div class="col-6 col-md-3 mb-2">
                                    <div class="h3 mb-0" id="longestRunGap">0</div>
                                    <div class="text-muted small">Longest Gap</div>
                                </div>
                            </div>
                            <p class="mt-2" id="runningConsistencyMsg"></p>
                            <div class="mt-3" id="showRunningGapDetailsContainer" style="display: none;">
                                <button class="btn btn-sm btn-outline-primary" onclick="toggleRunningGapDetails()">
                                    <span id="runningGapDetailsToggleText">Show Gap Details</span>
                                </button>
                            </div>
                            <div class="mt-3" id="runningGapDetailsSection" style="display: none;">
                                <div class="alert alert-warning">
                                    <h6 class="alert-heading">Missed Running Days:</h6>
                                    <div id="runningGapDetailsList"></div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Running Stats -->
            <div class="tab-pane fade" id="run-stats" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Run Distance Distribution (miles)</h5>
                                <canvas id="runDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Running Stats Summary</h5>
                                <div id="runStatsContent" class="row"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combined Trends -->
            <div class="tab-pane fade" id="trends" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Running Trends</h5>

                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" id="trendDailyBtn">Daily</button>
                            <button type="button" class="btn btn-outline-primary" id="trendWeeklyBtn">Weekly</button>
                            <button type="button" class="btn btn-outline-primary" id="trendMonthlyBtn">Monthly</button>
                        </div>

                        <!-- Stacked charts: Mileage on top, Pace below -->
                        <div class="mb-4">
                            <h6 class="text-muted">Mileage</h6>
                            <canvas id="mileageTrendChart"></canvas>
                        </div>
                        <div>
                            <h6 class="text-muted">Pace</h6>
                            <canvas id="paceTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let activityCountChart, timeDistChart, mileageTrendChart, paceTrendChart, runDistributionChart;
        let currentTrendPeriod = 'daily';
        let activeRequests = 0;

        // Loading spinner management
        function showLoadingSpinner() {
            activeRequests++;
            document.getElementById('globalLoadingSpinner').style.display = 'block';
        }

        function hideLoadingSpinner() {
            activeRequests--;
            if (activeRequests <= 0) {
                activeRequests = 0;
                document.getElementById('globalLoadingSpinner').style.display = 'none';
            }
        }

        // Error handling helpers
        function showErrorToast(message, showRetry = false, retryCallback = null) {
            const toastElement = document.getElementById('errorToast');
            const messageElement = document.getElementById('errorToastMessage');

            if (showRetry && retryCallback) {
                messageElement.innerHTML = `${message} <button class="btn btn-sm btn-light ms-2" onclick="(${retryCallback.toString()})()">Retry</button>`;
            } else {
                messageElement.textContent = message;
            }

            const toast = new bootstrap.Toast(toastElement, { delay: 7000 });
            toast.show();
        }

        function handleFetchError(error, context, retryCallback = null) {
            console.error(`Error loading ${context}:`, error);

            // Check if error message contains HTTP status
            const statusMatch = error.message.match(/HTTP (\d+)/);
            let message = `Unable to load ${context}.`;
            let showRetry = true;

            if (statusMatch) {
                const status = parseInt(statusMatch[1]);
                switch(status) {
                    case 401:
                        message = 'Authentication failed. Please reconnect with Strava.';
                        showRetry = false;
                        // Redirect to login after 3 seconds
                        setTimeout(() => window.location.href = '/logout', 3000);
                        break;
                    case 403:
                        message = 'Access denied. Please check your Strava permissions.';
                        showRetry = false;
                        break;
                    case 429:
                        message = 'Rate limit exceeded. Please try again in a few minutes.';
                        showRetry = false;
                        break;
                    case 500:
                    case 502:
                    case 503:
                    case 504:
                        message = 'Server error. Please try again in a moment.';
                        showRetry = true;
                        break;
                    default:
                        message = `Unable to load ${context}. Please try again.`;
                        showRetry = true;
                }
            }

            showErrorToast(message, showRetry, retryCallback);
        }

        // Enhanced fetch wrapper with automatic spinner management
        function fetchWithSpinner(url, context, retryCallback = null) {
            showLoadingSpinner();
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    handleFetchError(error, context, retryCallback);
                    throw error;
                })
                .finally(() => {
                    hideLoadingSpinner();
                });
        }

        function getDateParams() {
            const after = document.getElementById('afterDate').value;
            const before = document.getElementById('beforeDate').value;
            let params = '';
            if (after) params += `after=${after}`;
            if (before) params += `${params ? '&' : ''}before=${before}`;
            return params ? '?' + params : '';
        }

        // Register plugins
        Chart.register(ChartDataLabels);

        function loadActivityCount() {
            fetchWithSpinner('/api/stats/activity-count' + getDateParams(), 'activity count', loadActivityCount)
                .then(data => {
                    const ctx = document.getElementById('activityCountChart').getContext('2d');
                    if (activityCountChart) activityCountChart.destroy();
                    activityCountChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.map(d => `${d.activityType} (${d.count} activities)`),
                            datasets: [{
                                data: data.map(d => d.count),
                                backgroundColor: generateColors(data.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'right' },
                                title: {
                                    display: true,
                                    text: 'Number of Activities by Type'
                                },
                                datalabels: {
                                    color: '#fff',
                                    font: { weight: 'bold' },
                                    anchor: 'center',
                                    align: 'center',
                                    clamp: true,
                                    formatter: (value, context) => {
                                        const arr = context.dataset.data;
                                        const total = arr.reduce((a, b) => a + b, 0) || 0;
                                        const pct = total ? (value / total * 100) : 0;
                                        // Only show 1 decimal if under 10%, else no decimals
                                        const pctStr = pct < 10 ? pct.toFixed(1) : Math.round(pct).toString();
                                        return `${value} (${pctStr}%)`;
                                    },
                                    display: (context) => {
                                        const v = context.dataset.data[context.dataIndex];
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0) || 0;
                                        return total && (v / total) >= 0.05; // show if >=5% of the pie
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(() => {}); // Error already handled in fetchWithSpinner
        }

        function loadTimeDistribution() {
            fetchWithSpinner('/api/stats/time-distribution' + getDateParams(), 'time distribution', loadTimeDistribution)
                .then(data => {
                    const ctx = document.getElementById('timeDistChart').getContext('2d');
                    if (timeDistChart) timeDistChart.destroy();
                    // Store original data for legend formatting
                    const originalData = data;
                    timeDistChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.map(d => `${d.activityType} (${d.formattedTime})`),
                            datasets: [{
                                data: data.map(d => d.hours),
                                backgroundColor: generateColors(data.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { 
                                    position: 'right',
                                    labels: {
                                        generateLabels: (chart) => {
                                            const chartData = chart.data;
                                            if (chartData.labels.length && chartData.datasets.length) {
                                                return chartData.labels.map((label, i) => {
                                                    const value = chartData.datasets[0].data[i];
                                                    const total = chartData.datasets[0].data.reduce((a, b) => a + b, 0);
                                                    const pct = total ? (value / total * 100) : 0;
                                                    const pctStr = pct < 10 ? pct.toFixed(1) : Math.round(pct).toString();
                                                    // Use formattedTime from original data (HH:MM format)
                                                    const formattedTime = originalData[i]?.formattedTime || formatHoursToHHMM(value);
                                                    const activityType = originalData[i]?.activityType || label.split(' (')[0];
                                                    return {
                                                        text: `${activityType} (${formattedTime}) - ${pctStr}%`,
                                                        fillStyle: chartData.datasets[0].backgroundColor[i],
                                                        hidden: false,
                                                        index: i
                                                    };
                                                });
                                            }
                                            return [];
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time Spent by Activity Type'
                                },
                                datalabels: {
                                    color: '#fff',
                                    font: { weight: 'bold' },
                                    anchor: 'center',
                                    align: 'center',
                                    clamp: true,
                                    formatter: (value, context) => {
                                        const arr = context.dataset.data;
                                        const total = arr.reduce((a, b) => a + b, 0) || 0;
                                        const pct = total ? (value / total * 100) : 0;
                                        const pctStr = pct < 10 ? pct.toFixed(1) : Math.round(pct).toString();
                                        // Prefer formatted HH:MM if available
                                        const idx = context.dataIndex;
                                        const formatted = (data && data[idx] && data[idx].formattedTime) ? data[idx].formattedTime : `${value.toFixed(1)}h`;
                                        return `${formatted} (${pctStr}%)`;
                                    },
                                    display: (context) => {
                                        const v = context.dataset.data[context.dataIndex];
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0) || 0;
                                        return total && (v / total) >= 0.05; // show if >=5% of the pie
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(() => {}); // Error already handled in fetchWithSpinner
        }

        function loadWorkoutHeatmap() {
            const params = getDateParams();
            showLoadingSpinner();
            const heatReq = fetch('/api/stats/workout-heatmap' + params)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                });
            const sumReq = fetch('/api/stats/workout-heatmap/summary' + params)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                });
            Promise.all([heatReq, sumReq]).then(([heat, s]) => {
                // Counters
                const setNum = (id, val) => document.getElementById(id).innerText = (val ?? 0);
                setNum('workoutDays', s.workoutDays);
                setNum('missedDays', s.missedDays);
                setNum('currentStreak', s.currentStreak);
                setNum('daysSinceLast', s.daysSinceLast);
                setNum('longestGap', s.longestGap);
                setNum('totalGapDays', s.totalGapDays);

                // Message
                const msg = document.getElementById('consistencyMsg');
                if ((s.missedDays ?? 0) === 0) {
                    msg.className = 'text-success';
                    msg.textContent = 'No gaps ‚Äî excellent consistency!';
                    document.getElementById('showGapDetailsContainer').style.display = 'none';
                } else if ((s.currentStreak ?? 0) >= 7) {
                    msg.className = 'text-success';
                    msg.textContent = 'Great job keeping a strong streak going!';
                    document.getElementById('showGapDetailsContainer').style.display = 'block';
                } else {
                    msg.className = 'text-muted';
                    msg.textContent = 'Keep building your routine ‚Äî every day counts.';
                    document.getElementById('showGapDetailsContainer').style.display = 'block';
                }

                // Build timeline and collect gap information
                // Ensure date is always a string in YYYY-MM-DD format for consistent matching
                const byDate = new Map(heat.map(h => {
                    const dateStr = typeof h.date === 'string' ? h.date : 
                        (h.date.year + '-' + String(h.date.month).padStart(2, '0') + '-' + String(h.date.day).padStart(2, '0'));
                    return [dateStr, h.value];
                }));
                
                // Use backend range (which uses the exact filter dates)
                // Normalize start date if coming from heatmap data
                let start = s.rangeStart;
                if (!start && heat.length > 0) {
                    const firstDate = heat[0].date;
                    start = typeof firstDate === 'string' ? firstDate : 
                        (firstDate.year + '-' + String(firstDate.month).padStart(2, '0') + '-' + String(firstDate.day).padStart(2, '0'));
                }
                const end = s.rangeEnd;
                const timeline = document.getElementById('workoutTimeline');
                timeline.innerHTML = '';
                if (!start || !end) {
                    timeline.innerHTML = '<span class="text-muted">No data</span>';
                    return;
                }

                // Update date range display with actual data
                const afterInput = document.getElementById('afterDate').value;
                const beforeInput = document.getElementById('beforeDate').value;
                if (!afterInput && !beforeInput) {
                    // Set the input field values
                    document.getElementById('afterDate').value = start;
                    document.getElementById('beforeDate').value = end;

                    // Update the display
                    document.getElementById('displayStartDate').textContent = start;
                    document.getElementById('displayEndDate').textContent = end;
                    const startDate = new Date(start);
                    const endDate = new Date(end);
                    const diffTime = Math.abs(endDate - startDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    document.getElementById('displayTotalDays').textContent = diffDays;
                    document.getElementById('dateRangeDisplay').style.display = 'block';
                }

                // Parse dates and normalize to avoid timezone issues
                const parseLocalDate = (dateStr) => {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    return new Date(year, month - 1, day);
                };
                const startDate = parseLocalDate(start);
                const endDate = parseLocalDate(end);
                let cur = new Date(startDate);
                const missedDays = [];
                
                // Iterate through all days in the range (inclusive of end date)
                const formatDate = (d) => {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                while (formatDate(cur) <= end) {
                    const key = formatDate(cur);
                    const hours = byDate.get(key) || 0;
                    const lvl = hours === 0 ? 0 : (hours < 1 ? 1 : (hours < 2 ? 2 : 3));
                    const box = document.createElement('div');
                    box.className = 'day-cell lvl-' + lvl;

                    // Format time as HH:MM
                    let timeStr = '';
                    if (hours > 0) {
                        const h = Math.floor(hours);
                        const m = Math.round((hours - h) * 60);
                        timeStr = ` ‚Äî ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    } else {
                        timeStr = ' ‚Äî No activity';
                    }

                    box.title = key + timeStr;
                    timeline.appendChild(box);

                    // Collect missed days - all days with no activity in the selected range
                    if (hours === 0) {
                        missedDays.push(key);
                    }

                    // Move to next day
                    cur.setDate(cur.getDate() + 1);
                }

                // Store missed days globally for the toggle function
                window.workoutMissedDays = missedDays;
            })
            .catch(error => handleFetchError(error, 'workout heatmap', loadWorkoutHeatmap))
            .finally(() => hideLoadingSpinner());
        }

        function toggleGapDetails() {
            const section = document.getElementById('gapDetailsSection');
            const toggleText = document.getElementById('gapDetailsToggleText');

            if (section.style.display === 'none') {
                // Show gap details
                const missedDays = window.workoutMissedDays || [];
                const listDiv = document.getElementById('gapDetailsList');

                if (missedDays.length === 0) {
                    listDiv.textContent = 'No missed days found.';
                } else {
                    listDiv.innerHTML = '<ul class="mb-0">' +
                        missedDays.map(day => `<li>${day}</li>`).join('') +
                        '</ul>';
                }

                section.style.display = 'block';
                toggleText.textContent = 'Hide Gap Details';
            } else {
                // Hide gap details
                section.style.display = 'none';
                toggleText.textContent = 'Show Gap Details';
            }
        }

        function toggleRunningGapDetails() {
            const section = document.getElementById('runningGapDetailsSection');
            const toggleText = document.getElementById('runningGapDetailsToggleText');

            if (section.style.display === 'none') {
                // Show gap details
                const missedDays = window.runningMissedDays || [];
                const listDiv = document.getElementById('runningGapDetailsList');

                if (missedDays.length === 0) {
                    listDiv.textContent = 'No missed running days found.';
                } else {
                    listDiv.innerHTML = '<ul class="mb-0">' +
                        missedDays.map(day => `<li>${day}</li>`).join('') +
                        '</ul>';
                }

                section.style.display = 'block';
                toggleText.textContent = 'Hide Gap Details';
            } else {
                // Hide gap details
                section.style.display = 'none';
                toggleText.textContent = 'Show Gap Details';
            }
        }

        function loadRunStatistics() {
            fetchWithSpinner('/api/stats/run-statistics' + getDateParams(), 'running statistics', loadRunStatistics)
                .then(data => {
                    const container = document.getElementById('runStatsContent');
                    container.innerHTML = `
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Total Runs</h6><h3>${data.totalRuns}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>10K+ Runs</h6><h3>${data.runs10KPlus}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Total Miles</h6><h3>${data.totalMiles}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Avg Pace</h6><h3>${data.averagePace} /mi</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Fastest Mile</h6><h3>${data.fastestMileSplit}</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Fastest 10K</h6><h3>${data.fastest10K}</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Longest Run</h6><h3>${data.longestRun} mi</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Most Elevation</h6><h3>${data.mostElevation} ft</h3></div></div></div>
                    `;
                    // Also load the run distribution chart
                    loadRunDistribution();
                })
                .catch(() => {}); // Error already handled in fetchWithSpinner
        }

        function loadRunDistribution() {
            fetchWithSpinner('/api/stats/run-distribution' + getDateParams(), 'run distribution', loadRunDistribution)
                .then(data => {
                    const ctx = document.getElementById('runDistributionChart').getContext('2d');
                    if (runDistributionChart) runDistributionChart.destroy();
                    runDistributionChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(d => d.distanceRange),
                            datasets: [{
                                label: 'Number of Runs',
                                data: data.map(d => d.count),
                                backgroundColor: 'rgba(75, 112, 235, 0.8)',
                                borderColor: 'rgba(75, 112, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                datalabels: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    title: {
                                        display: true,
                                        text: 'Number of Runs'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Distance Range (miles)'
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(() => {}); // Error already handled in fetchWithSpinner
        }

        function loadRunningHeatmap() {
            fetchWithSpinner('/api/stats/running-heatmap' + getDateParams(), 'running heatmap', loadRunningHeatmap)
                .then(data => {
                    const container = document.getElementById('runningHeatmap');
                    container.innerHTML = '';

                    // Helper function to format date as YYYY-MM-DD in local timezone
                    function formatLocalDate(date) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }

                    // Helper function to create date from YYYY-MM-DD string in local timezone
                    function parseLocalDate(dateStr) {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        return new Date(year, month - 1, day);
                    }

                    // Get the actual filter date range
                    const afterInput = document.getElementById('afterDate').value;
                    const beforeInput = document.getElementById('beforeDate').value;
                    
                    // Determine the range: use filter dates if provided, otherwise use data range
                    let startDate, endDate;
                    if (afterInput && beforeInput) {
                        startDate = parseLocalDate(afterInput);
                        endDate = parseLocalDate(beforeInput);
                    } else if (data && data.length > 0) {
                        const dates = data.map(d => parseLocalDate(d.date));
                        startDate = new Date(Math.min(...dates));
                        endDate = new Date(Math.max(...dates));
                    } else {
                        container.innerHTML = '<span class="text-muted">No running data</span>';
                        return;
                    }

                    // Create a map of date to miles
                    const byDate = new Map(data.map(h => [h.date, h.value]));

                    // Calculate statistics
                    let runningDays = 0;
                    let nonRunningDays = 0;
                    let currentStreak = 0;
                    let longestGap = 0;
                    let currentGap = 0;

                    // Build all dates in the range
                    let cur = new Date(startDate);
                    const allDates = [];
                    const endDateStr = formatLocalDate(endDate);
                    while (true) {
                        const curDateStr = formatLocalDate(cur);
                        allDates.push(curDateStr);
                        if (curDateStr === endDateStr) break;
                        cur.setDate(cur.getDate() + 1);
                    }

                    // Calculate current streak from end date backwards
                    for (let i = allDates.length - 1; i >= 0; i--) {
                        const key = allDates[i];
                        const miles = byDate.get(key) || 0;
                        if (miles > 0) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }

                    // Build timeline and calculate stats over the full range
                    const missedRunningDays = [];
                    cur = new Date(startDate);
                    while (true) {
                        const key = formatLocalDate(cur);
                        const miles = byDate.get(key) || 0;
                        const lvl = miles === 0 ? 0 : (miles < 3 ? 1 : (miles < 6 ? 2 : (miles < 10 ? 3 : 4)));
                        const box = document.createElement('div');
                        box.className = 'day-cell lvl-' + lvl;
                        box.title = key + (miles ? ` ‚Äî ${miles.toFixed(2)} mi` : ' ‚Äî No run');
                        container.appendChild(box);

                        // Count running vs non-running days
                        if (miles > 0) {
                            runningDays++;
                            currentGap = 0;
                        } else {
                            nonRunningDays++;
                            currentGap++;
                            missedRunningDays.push(key);
                            if (currentGap > longestGap) {
                                longestGap = currentGap;
                            }
                        }

                        if (key === endDateStr) break;
                        cur.setDate(cur.getDate() + 1);
                    }

                    // Update statistics display
                    document.getElementById('runningDays').textContent = runningDays;
                    document.getElementById('nonRunningDays').textContent = nonRunningDays;
                    document.getElementById('currentRunStreak').textContent = currentStreak;
                    document.getElementById('longestRunGap').textContent = longestGap;

                    // Show/hide gap details button
                    const msg = document.getElementById('runningConsistencyMsg');
                    if (nonRunningDays === 0) {
                        msg.className = 'text-success';
                        msg.textContent = 'Perfect! You ran every day!';
                        document.getElementById('showRunningGapDetailsContainer').style.display = 'none';
                    } else if (currentStreak >= 7) {
                        msg.className = 'text-success';
                        msg.textContent = 'Great running streak!';
                        document.getElementById('showRunningGapDetailsContainer').style.display = 'block';
                    } else {
                        msg.className = 'text-muted';
                        msg.textContent = 'Keep building your running routine!';
                        document.getElementById('showRunningGapDetailsContainer').style.display = 'block';
                    }

                    // Store missed days for the toggle function
                    window.runningMissedDays = missedRunningDays;
                })
                .catch(() => {}); // Error already handled in fetchWithSpinner
        }

        function loadMileageTrend(period) {
            // Currently backend mileage-trend is across activities; for 'running' mode we keep same API
            // In the future, backend can support a mode param; for now just pass period and date range
            fetchWithSpinner('/api/stats/mileage-trend' + getDateParams() + (getDateParams() ? '&' : '?') + 'period=' + period, 'mileage trend', () => loadMileageTrend(period))
                .then(data => {
                    const ctx = document.getElementById('mileageTrendChart').getContext('2d');
                    if (mileageTrendChart) mileageTrendChart.destroy();
                    mileageTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.label),
                            datasets: [{
                                label: 'Miles',
                                data: data.map(d => d.value),
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                datalabels: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' mi';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Miles'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(() => {}); // Error already handled in fetchWithSpinner
        }

        function loadPaceTrend(period) {
            // Pace trend is inherently running-focused; we reuse same endpoint for both modes
            fetchWithSpinner('/api/stats/pace-trend' + getDateParams() + (getDateParams() ? '&' : '?') + 'period=' + period, 'pace trend', () => loadPaceTrend(period))
                .then(data => {
                    const ctx = document.getElementById('paceTrendChart').getContext('2d');
                    if (paceTrendChart) paceTrendChart.destroy();
                    paceTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.label),
                            datasets: [{
                                label: 'Pace',
                                data: data.map(d => d.value),
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                datalabels: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const mins = Math.floor(context.parsed.y / 60);
                                            const secs = Math.floor(context.parsed.y % 60);
                                            return 'Pace: ' + mins + ':' + (secs < 10 ? '0' : '') + secs + ' /mi';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'Pace (min/mile)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            const mins = Math.floor(value / 60);
                                            const secs = Math.floor(value % 60);
                                            return mins + ':' + (secs < 10 ? '0' : '') + secs;
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(() => {}); // Error already handled in fetchWithSpinner
        }

        function setActiveQuickPick(activeId) {
            const group = document.getElementById('quickPickGroup');
            if (!group) return;
            Array.from(group.querySelectorAll('button')).forEach(btn => btn.classList.remove('active'));
            if (activeId) {
                const btn = document.getElementById(activeId);
                if (btn) btn.classList.add('active');
            }
        }

        function setDateRange(days, btnId) {
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];

            if (days === 0) {
                // All time - clear dates to show all data
                document.getElementById('afterDate').value = '';
                document.getElementById('beforeDate').value = '';
            } else {
                // Inclusive range: for N days ending today, start is (N-1) days ago
                const startDate = new Date(today);
                const offset = Math.max(0, (days - 1));
                startDate.setDate(startDate.getDate() - offset);
                document.getElementById('afterDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('beforeDate').value = endDate;
            }

            // Hide custom date row when a preset is chosen
            hideCustomRange();
            // Reflect active preset button
            setActiveQuickPick(btnId);

            // Apply the filter
            loadAllData();
        }

        function setDateRangeYTD(btnId) {
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];
            // Set start date to January 1st of the current year (format as YYYY-MM-DD to avoid timezone issues)
            const year = today.getFullYear();
            const startDate = `${year}-01-01`;
            document.getElementById('afterDate').value = startDate;
            document.getElementById('beforeDate').value = endDate;
            // Apply the filter
            hideCustomRange();
            setActiveQuickPick(btnId);
            loadAllData();
        }

        function updateDateRangeDisplay() {
            const after = document.getElementById('afterDate').value;
            const before = document.getElementById('beforeDate').value;
            const display = document.getElementById('dateRangeDisplay');

            if (after || before) {
                const startDate = after || '(earliest activity)';
                const endDate = before || '(latest activity)';

                document.getElementById('displayStartDate').textContent = startDate;
                document.getElementById('displayEndDate').textContent = endDate;

                // Calculate days if both dates are provided
                if (after && before) {
                    const start = new Date(after);
                    const end = new Date(before);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    document.getElementById('displayTotalDays').textContent = diffDays;
                } else {
                    document.getElementById('displayTotalDays').textContent = 'N/A';
                }

                display.style.display = 'block';
            } else {
                display.style.display = 'none';
            }
        }

        function loadSummaryStats() {
            fetchWithSpinner('/api/stats/summary' + getDateParams(), 'summary stats', loadSummaryStats)
                .then(data => {
                    document.getElementById('displayTotalActivities').textContent = data.totalActivities;

                    // Convert seconds to HH:MM:SS format
                    const hours = Math.floor(data.totalMovingTimeSeconds / 3600);
                    const minutes = Math.floor((data.totalMovingTimeSeconds % 3600) / 60);
                    const seconds = data.totalMovingTimeSeconds % 60;
                    const timeStr = `${hours}h ${minutes}m ${seconds}s`;

                    document.getElementById('displayTotalMovingTime').textContent = timeStr;
                })
                .catch(() => {}); // Error already handled in fetchWithSpinner
        }

        function loadAllData() {
            updateDateRangeDisplay();
            loadSummaryStats();
            loadActivityCount();
            loadTimeDistribution();
            loadWorkoutHeatmap();
            loadRunStatistics(); // This also loads run distribution
            loadRunningHeatmap();
            // Initialize trends with current selections
            loadMileageTrend(currentTrendPeriod);
            loadPaceTrend(currentTrendPeriod);
        }

        // Streaks tab toggle handlers
        (function initStreaksToggle(){
            function showWorkout(){
                const w = document.getElementById('streaks-workout-section');
                const r = document.getElementById('streaks-running-section');
                if (!w || !r) return;
                w.style.display = '';
                r.style.display = 'none';
                // Ensure data is fresh for current date filter
                loadWorkoutHeatmap();
            }
            function showRunning(){
                const w = document.getElementById('streaks-workout-section');
                const r = document.getElementById('streaks-running-section');
                if (!w || !r) return;
                w.style.display = 'none';
                r.style.display = '';
                loadRunningHeatmap();
            }

            // Wire radio buttons
            const workoutBtn = document.getElementById('streakModeWorkout');
            const runningBtn = document.getElementById('streakModeRunning');
            if (workoutBtn) workoutBtn.addEventListener('change', e => { if (e.target.checked) showWorkout(); });
            if (runningBtn) runningBtn.addEventListener('change', e => { if (e.target.checked) showRunning(); });

            // When the Streaks tab becomes active, refresh the visible section
            const streaksTabBtn = document.getElementById('streaks-tab');
            if (streaksTabBtn) {
                streaksTabBtn.addEventListener('shown.bs.tab', () => {
                    if (runningBtn && runningBtn.checked) {
                        showRunning();
                    } else {
                        showWorkout();
                    }
                });
            }
        })();

        function generateColors(count) {
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            return colors.slice(0, count);
        }

        function formatHoursToHHMM(hours) {
            const totalMinutes = Math.round(hours * 60);
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // Trends tab: wire period buttons
        (function initTrendsControls(){
            const dailyBtn = document.getElementById('trendDailyBtn');
            const weeklyBtn = document.getElementById('trendWeeklyBtn');
            const monthlyBtn = document.getElementById('trendMonthlyBtn');

            function setActive(btn){
                [dailyBtn, weeklyBtn, monthlyBtn].forEach(b => b && b.classList.remove('active'));
                btn && btn.classList.add('active');
            }

            if (dailyBtn) dailyBtn.addEventListener('click', () => { currentTrendPeriod = 'daily'; setActive(dailyBtn); loadMileageTrend('daily'); loadPaceTrend('daily'); });
            if (weeklyBtn) weeklyBtn.addEventListener('click', () => { currentTrendPeriod = 'weekly'; setActive(weeklyBtn); loadMileageTrend('weekly'); loadPaceTrend('weekly'); });
            if (monthlyBtn) monthlyBtn.addEventListener('click', () => { currentTrendPeriod = 'monthly'; setActive(monthlyBtn); loadMileageTrend('monthly'); loadPaceTrend('monthly'); });

            // When the Trends tab is shown, refresh charts
            const trendsTabBtn = document.getElementById('trends-tab');
            if (trendsTabBtn) {
                trendsTabBtn.addEventListener('shown.bs.tab', () => {
                    loadMileageTrend(currentTrendPeriod);
                    loadPaceTrend(currentTrendPeriod);
                });
            }

            // Default UI state
            setActive(dailyBtn);
        })();

        // Custom range helpers
        function showCustomRange(btnId) {
            const row = document.getElementById('customDateRow');
            if (row) row.style.display = '';
            const startInput = document.getElementById('afterDate');
            if (startInput) startInput.focus();
            // Validate initial state
            validateCustomRange();
            setActiveQuickPick(btnId || 'btnCustom');
        }

        function hideCustomRange() {
            const row = document.getElementById('customDateRow');
            if (row) row.style.display = 'none';
            const err = document.getElementById('customRangeError');
            if (err) err.style.display = 'none';
            const applyBtn = document.getElementById('applyCustomBtn');
            if (applyBtn) applyBtn.disabled = false;
        }

        function validateCustomRange() {
            const start = document.getElementById('afterDate').value;
            const end = document.getElementById('beforeDate').value;
            const err = document.getElementById('customRangeError');
            const applyBtn = document.getElementById('applyCustomBtn');
            if (start && end) {
                const s = new Date(start);
                const e = new Date(end);
                if (s > e) {
                    if (err) err.style.display = '';
                    if (applyBtn) applyBtn.disabled = true;
                    return false;
                }
            }
            if (err) err.style.display = 'none';
            if (applyBtn) applyBtn.disabled = false;
            // If both dates are present and valid, attempt to match a preset and highlight it; else keep Custom active
            if (start && end) {
                const s = new Date(start);
                const e = new Date(end);
                // Normalize to midnight local
                s.setHours(0,0,0,0);
                e.setHours(0,0,0,0);
                const today = new Date(); today.setHours(0,0,0,0);
                const diffDays = Math.round((e - s) / (1000*60*60*24)) + 1; // inclusive
                const matchesTodayEnd = e.getTime() === today.getTime();
                if (matchesTodayEnd) {
                    // YTD: Jan 1st of this year to today
                    const y = today.getFullYear();
                    const jan1 = new Date(y, 0, 1); jan1.setHours(0,0,0,0);
                    if (s.getTime() === jan1.getTime()) {
                        setActiveQuickPick('btnYTD');
                        return true;
                    }
                    const presetMap = {7:'btnLast7',30:'btnLast30',90:'btnLast90',180:'btnLast180',365:'btnLast365'};
                    if (presetMap[diffDays]) {
                        setActiveQuickPick(presetMap[diffDays]);
                    } else {
                        setActiveQuickPick('btnCustom');
                    }
                } else {
                    // YTD match: start Jan 1 this year and end today
                    setActiveQuickPick('btnCustom');
                }
            } else {
                setActiveQuickPick('btnCustom');
            }
            return true;
        }

        // Global error boundary - catch unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showErrorToast('An unexpected error occurred. Please refresh the page.');
            event.preventDefault();
        });

        // Global error boundary - catch JavaScript errors
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showErrorToast('An unexpected error occurred. Please refresh the page.');
        });

        // Load data on page load with default 7 days
        window.addEventListener('load', function() {
            setDateRange(7, 'btnLast7'); // Default to last 7 days
        });
    </script>
</body>
</html>
