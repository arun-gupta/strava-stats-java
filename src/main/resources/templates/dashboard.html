<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Strava Stats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Strava Stats</a>
            <span class="navbar-text text-white" th:if="${name}">
                Welcome, <span th:text="${name}"></span>
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Dashboard</h2>

        <!-- Date Range Filter -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Date Range</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label for="afterDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="afterDate">
                            </div>
                            <div class="col-md-3">
                                <label for="beforeDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="beforeDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary d-block" onclick="loadAllData()">Apply Filter</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="statsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="activity-count-tab" data-bs-toggle="tab"
                        data-bs-target="#activity-count" type="button" role="tab">
                    Activity Count
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="time-dist-tab" data-bs-toggle="tab"
                        data-bs-target="#time-dist" type="button" role="tab">
                    Time Distribution
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="workout-streaks-tab" data-bs-toggle="tab"
                        data-bs-target="#workout-streaks" type="button" role="tab">
                    Workout Streaks
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="run-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#run-stats" type="button" role="tab">
                    Run Statistics
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="running-heatmap-tab" data-bs-toggle="tab"
                        data-bs-target="#running-heatmap" type="button" role="tab">
                    Running Heatmap
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="mileage-trend-tab" data-bs-toggle="tab"
                        data-bs-target="#mileage-trend" type="button" role="tab">
                    Mileage Trend
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pace-trend-tab" data-bs-toggle="tab"
                        data-bs-target="#pace-trend" type="button" role="tab">
                    Pace Trend
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3" id="statsTabContent">
            <!-- Activity Count Distribution -->
            <div class="tab-pane fade show active" id="activity-count" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Activity Count Distribution</h5>
                        <canvas id="activityCountChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Time Distribution -->
            <div class="tab-pane fade" id="time-dist" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Time Distribution</h5>
                        <canvas id="timeDistChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Workout Streaks -->
            <div class="tab-pane fade" id="workout-streaks" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Workout Streaks Heatmap</h5>
                        <div id="workoutStreaksHeatmap"></div>
                    </div>
                </div>
            </div>

            <!-- Run Statistics -->
            <div class="tab-pane fade" id="run-stats" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Running Statistics</h5>
                        <div id="runStatsContent" class="row"></div>
                    </div>
                </div>
            </div>

            <!-- Running Heatmap -->
            <div class="tab-pane fade" id="running-heatmap" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Running Heatmap</h5>
                        <div id="runningHeatmap"></div>
                    </div>
                </div>
            </div>

            <!-- Mileage Trend -->
            <div class="tab-pane fade" id="mileage-trend" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Mileage Trend</h5>
                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="loadMileageTrend('daily')">Daily</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadMileageTrend('weekly')">Weekly</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadMileageTrend('monthly')">Monthly</button>
                        </div>
                        <canvas id="mileageTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Pace Trend -->
            <div class="tab-pane fade" id="pace-trend" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Pace Trend</h5>
                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="loadPaceTrend('daily')">Daily</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadPaceTrend('weekly')">Weekly</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadPaceTrend('monthly')">Monthly</button>
                        </div>
                        <canvas id="paceTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let activityCountChart, timeDistChart, mileageTrendChart, paceTrendChart;

        function getDateParams() {
            const after = document.getElementById('afterDate').value;
            const before = document.getElementById('beforeDate').value;
            let params = '';
            if (after) params += `after=${after}`;
            if (before) params += `${params ? '&' : ''}before=${before}`;
            return params ? '?' + params : '';
        }

        function loadActivityCount() {
            fetch('/api/stats/activity-count' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('activityCountChart').getContext('2d');
                    if (activityCountChart) activityCountChart.destroy();
                    activityCountChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.map(d => d.activityType),
                            datasets: [{
                                data: data.map(d => d.count),
                                backgroundColor: generateColors(data.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'right' }
                            }
                        }
                    });
                });
        }

        function loadTimeDistribution() {
            fetch('/api/stats/time-distribution' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('timeDistChart').getContext('2d');
                    if (timeDistChart) timeDistChart.destroy();
                    timeDistChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.map(d => `${d.activityType} (${d.formattedTime})`),
                            datasets: [{
                                data: data.map(d => d.hours),
                                backgroundColor: generateColors(data.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'right' }
                            }
                        }
                    });
                });
        }

        function loadWorkoutStreaks() {
            fetch('/api/stats/workout-streaks' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('workoutStreaksHeatmap');
                    container.innerHTML = '<p class="text-muted">Heatmap visualization - ' + data.length + ' days of activity</p>';
                    // TODO: Implement proper heatmap visualization
                });
        }

        function loadRunStatistics() {
            fetch('/api/stats/run-statistics' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('runStatsContent');
                    container.innerHTML = `
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Total Runs</h6><h3>${data.totalRuns}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>10K+ Runs</h6><h3>${data.runs10KPlus}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Total Miles</h6><h3>${data.totalMiles}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Avg Pace</h6><h3>${data.averagePace} /mi</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Fastest Mile</h6><h3>${data.fastestMileSplit}</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Fastest 10K</h6><h3>${data.fastest10K}</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Longest Run</h6><h3>${data.longestRun} mi</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Most Elevation</h6><h3>${data.mostElevation} ft</h3></div></div></div>
                    `;
                });
        }

        function loadRunningHeatmap() {
            fetch('/api/stats/running-heatmap' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('runningHeatmap');
                    container.innerHTML = '<p class="text-muted">Running heatmap - ' + data.length + ' days of running</p>';
                    // TODO: Implement proper heatmap visualization
                });
        }

        function loadMileageTrend(period) {
            fetch('/api/stats/mileage-trend' + getDateParams() + (getDateParams() ? '&' : '?') + 'period=' + period)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('mileageTrendChart').getContext('2d');
                    if (mileageTrendChart) mileageTrendChart.destroy();
                    mileageTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.label),
                            datasets: [{
                                label: 'Miles',
                                data: data.map(d => d.value),
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                });
        }

        function loadPaceTrend(period) {
            fetch('/api/stats/pace-trend' + getDateParams() + (getDateParams() ? '&' : '?') + 'period=' + period)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('paceTrendChart').getContext('2d');
                    if (paceTrendChart) paceTrendChart.destroy();
                    paceTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.label),
                            datasets: [{
                                label: 'Pace (sec/mile)',
                                data: data.map(d => d.value),
                                borderColor: 'rgb(255, 99, 132)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            const mins = Math.floor(value / 60);
                                            const secs = Math.floor(value % 60);
                                            return mins + ':' + (secs < 10 ? '0' : '') + secs;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function loadAllData() {
            loadActivityCount();
            loadTimeDistribution();
            loadWorkoutStreaks();
            loadRunStatistics();
            loadRunningHeatmap();
            loadMileageTrend('daily');
            loadPaceTrend('daily');
        }

        function generateColors(count) {
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            return colors.slice(0, count);
        }

        // Load data on page load
        window.addEventListener('load', loadAllData);
    </script>
</body>
</html>
