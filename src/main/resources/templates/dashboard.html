<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Strava Stats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Chart.js data labels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        /* Reduce pie chart size to 50% and center it */
        .chart-half {
            max-width: 50%;
            margin: 0 auto;
        }
        .chart-half canvas {
            width: 100% !important; /* let the container control actual width */
            height: auto !important;
        }
        /* Workout heatmap timeline */
        .timeline-wrapper {
            border: 1px solid #eee;
            border-radius: .5rem;
            padding: .5rem .75rem;
            overflow-x: auto;
            white-space: nowrap;
            background: #fff;
        }
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(14px, 14px));
            gap: 3px;
            max-width: 100%;
            border: 1px solid #eee;
            border-radius: .5rem;
            padding: .75rem;
            background: #fff;
            justify-content: start;
        }
        .day-box {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin: 2px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .day-cell {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .lvl-0 { background: #f2f2f2; }
        .lvl-1 { background: #ffe0b2; } /* < 1h or < 3mi */
        .lvl-2 { background: #ffb74d; } /* 1h - 2h or 3-6mi */
        .lvl-3 { background: #fb8c00; } /* 2h+ or 6-10mi */
        .lvl-4 { background: #e65100; } /* 10mi+ */
        .legend-item { display: inline-flex; align-items: center; margin-right: 12px; }
        .legend-swatch { width: 14px; height: 14px; border-radius:3px; display:inline-block; margin-right:6px; border:1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Strava Stats</a>
            <div class="d-flex align-items-center ms-auto">
                <span class="navbar-text text-white me-3" th:if="${name}">
                    Welcome, <span th:text="${name}"></span>
                </span>
                <a href="https://github.com/arun-gupta/strava-stats-java" target="_blank" rel="noopener noreferrer"
                   class="text-white" title="View on GitHub" style="text-decoration: none;">
                    <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" style="fill: currentColor;">
                        <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path>
                    </svg>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Strava Activity Analysis</h2>

        <!-- Date Range Filter -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Date Range</h5>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Quick Pick</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(7)">Last 7 Days</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(30)">Last 30 Days</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(90)">Last 90 Days</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(180)">Last 6 Months</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(365)">Last Year</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRangeYTD()">YTD</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange(0)">All Time</button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <label for="afterDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="afterDate">
                            </div>
                            <div class="col-md-3">
                                <label for="beforeDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="beforeDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary d-block" onclick="loadAllData()">Apply Filter</button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div id="dateRangeDisplay" class="alert alert-info mb-0" style="display:none;">
                                    <strong>Current Range:</strong> <span id="displayStartDate"></span> to <span id="displayEndDate"></span>
                                    (<span id="displayTotalDays"></span> days)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="statsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="activity-count-tab" data-bs-toggle="tab"
                        data-bs-target="#activity-count" type="button" role="tab">
                    üìä Activity Count
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="time-dist-tab" data-bs-toggle="tab"
                        data-bs-target="#time-dist" type="button" role="tab">
                    ‚è±Ô∏è Time Distribution
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="workout-heatmap-tab" data-bs-toggle="tab"
                        data-bs-target="#workout-heatmap" type="button" role="tab">
                    üí™ Workout Heatmap
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="running-heatmap-tab" data-bs-toggle="tab"
                        data-bs-target="#running-heatmap" type="button" role="tab">
                    üî• Running Heatmap
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="run-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#run-stats" type="button" role="tab">
                    üèÉ Running Stats
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="mileage-trend-tab" data-bs-toggle="tab"
                        data-bs-target="#mileage-trend" type="button" role="tab">
                    üìà Mileage Trend
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pace-trend-tab" data-bs-toggle="tab"
                        data-bs-target="#pace-trend" type="button" role="tab">
                    ‚ö° Pace Trend
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3" id="statsTabContent">
            <!-- Activity Count Distribution -->
            <div class="tab-pane fade show active" id="activity-count" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Activity Count Distribution</h5>
                        <div class="chart-half">
                            <canvas id="activityCountChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Distribution -->
            <div class="tab-pane fade" id="time-dist" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Time Distribution</h5>
                        <div class="chart-half">
                            <canvas id="timeDistChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workout Heatmap -->
            <div class="tab-pane fade" id="workout-heatmap" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Workout Heatmap</h5>
                        <p class="text-muted small mb-2">This view tracks all your activities (running, cycling, workouts, etc.), showing your consistency across all workout types. It measures consecutive days with at least one activity.</p>
                        <div class="d-flex justify-content-end align-items-center small text-muted mb-2">
                            <div class="legend-item"><span class="legend-swatch lvl-0"></span>No Activity</div>
                            <div class="legend-item"><span class="legend-swatch lvl-1"></span>< 1h</div>
                            <div class="legend-item"><span class="legend-swatch lvl-2"></span>1‚Äì2h</div>
                            <div class="legend-item"><span class="legend-swatch lvl-3"></span>2h+</div>
                        </div>
                        <div id="workoutTimeline" class="heatmap-grid mb-3"></div>
                        <div class="row text-center" id="streakCounters">
                            <div class="col-6 col-md-2 mb-2">
                                <div class="h3 mb-0" id="workoutDays">0</div>
                                <div class="text-muted small">Workout Days</div>
                            </div>
                            <div class="col-6 col-md-2 mb-2">
                                <div class="h3 mb-0" id="missedDays">0</div>
                                <div class="text-muted small">Missed Days</div>
                            </div>
                            <div class="col-6 col-md-2 mb-2">
                                <div class="h3 mb-0" id="currentStreak">0</div>
                                <div class="text-muted small">Current Streak</div>
                            </div>
                            <div class="col-6 col-md-2 mb-2">
                                <div class="h3 mb-0" id="daysSinceLast">0</div>
                                <div class="text-muted small">Days Since Last</div>
                            </div>
                            <div class="col-6 col-md-2 mb-2">
                                <div class="h3 mb-0" id="longestGap">0</div>
                                <div class="text-muted small">Longest Gap</div>
                            </div>
                            <div class="col-6 col-md-2 mb-2">
                                <div class="h3 mb-0" id="totalGapDays">0</div>
                                <div class="text-muted small">Total Gap Days</div>
                            </div>
                        </div>
                        <p class="mt-2" id="consistencyMsg"></p>
                        <div class="mt-3" id="showGapDetailsContainer" style="display: none;">
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleGapDetails()">
                                <span id="gapDetailsToggleText">Show Gap Details</span>
                            </button>
                        </div>
                        <div class="mt-3" id="gapDetailsSection" style="display: none;">
                            <div class="alert alert-warning">
                                <h6 class="alert-heading">Missed Days:</h6>
                                <div id="gapDetailsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Running Heatmap -->
            <div class="tab-pane fade" id="running-heatmap" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Running Heatmap</h5>
                        <p class="text-muted small mb-2">This view tracks your running activities, showing daily mileage with color-coded intensity.</p>
                        <div class="d-flex justify-content-end align-items-center small text-muted mb-2">
                            <div class="legend-item"><span class="legend-swatch lvl-0"></span>Non-Running</div>
                            <div class="legend-item"><span class="legend-swatch lvl-1"></span>Easy</div>
                            <div class="legend-item"><span class="legend-swatch lvl-2"></span>Moderate</div>
                            <div class="legend-item"><span class="legend-swatch lvl-3"></span>Big Day</div>
                        </div>
                        <div id="runningHeatmap" class="heatmap-grid mb-3"></div>
                        <div class="row text-center" id="runningStats">
                            <div class="col-6 col-md-3 mb-2">
                                <div class="h3 mb-0" id="runningDays">0</div>
                                <div class="text-muted small">Running Days</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="h3 mb-0" id="nonRunningDays">0</div>
                                <div class="text-muted small">Non-Running Days</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="h3 mb-0" id="currentRunStreak">0</div>
                                <div class="text-muted small">Current Streak</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="h3 mb-0" id="longestRunGap">0</div>
                                <div class="text-muted small">Longest Gap</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Running Stats -->
            <div class="tab-pane fade" id="run-stats" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Run Distance Distribution (miles)</h5>
                                <canvas id="runDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Running Stats Summary</h5>
                                <div id="runStatsContent" class="row"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mileage Trend -->
            <div class="tab-pane fade" id="mileage-trend" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Mileage Trend</h5>
                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="loadMileageTrend('daily')">Daily</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadMileageTrend('weekly')">Weekly</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadMileageTrend('monthly')">Monthly</button>
                        </div>
                        <canvas id="mileageTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Pace Trend -->
            <div class="tab-pane fade" id="pace-trend" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Pace Trend</h5>
                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="loadPaceTrend('daily')">Daily</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadPaceTrend('weekly')">Weekly</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadPaceTrend('monthly')">Monthly</button>
                        </div>
                        <canvas id="paceTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let activityCountChart, timeDistChart, mileageTrendChart, paceTrendChart, runDistributionChart;

        function getDateParams() {
            const after = document.getElementById('afterDate').value;
            const before = document.getElementById('beforeDate').value;
            let params = '';
            if (after) params += `after=${after}`;
            if (before) params += `${params ? '&' : ''}before=${before}`;
            return params ? '?' + params : '';
        }

        // Register plugins
        Chart.register(ChartDataLabels);

        function loadActivityCount() {
            fetch('/api/stats/activity-count' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('activityCountChart').getContext('2d');
                    if (activityCountChart) activityCountChart.destroy();
                    activityCountChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.map(d => `${d.activityType} (${d.count} activities)`),
                            datasets: [{
                                data: data.map(d => d.count),
                                backgroundColor: generateColors(data.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'right' },
                                title: {
                                    display: true,
                                    text: 'Number of Activities by Type'
                                },
                                datalabels: {
                                    color: '#fff',
                                    font: { weight: 'bold' },
                                    anchor: 'center',
                                    align: 'center',
                                    clamp: true,
                                    formatter: (value, context) => {
                                        const arr = context.dataset.data;
                                        const total = arr.reduce((a, b) => a + b, 0) || 0;
                                        const pct = total ? (value / total * 100) : 0;
                                        // Only show 1 decimal if under 10%, else no decimals
                                        const pctStr = pct < 10 ? pct.toFixed(1) : Math.round(pct).toString();
                                        return `${value} (${pctStr}%)`;
                                    },
                                    display: (context) => {
                                        const v = context.dataset.data[context.dataIndex];
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0) || 0;
                                        return total && (v / total) >= 0.05; // show if >=5% of the pie
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function loadTimeDistribution() {
            fetch('/api/stats/time-distribution' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('timeDistChart').getContext('2d');
                    if (timeDistChart) timeDistChart.destroy();
                    // Store original data for legend formatting
                    const originalData = data;
                    timeDistChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.map(d => `${d.activityType} (${d.formattedTime})`),
                            datasets: [{
                                data: data.map(d => d.hours),
                                backgroundColor: generateColors(data.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { 
                                    position: 'right',
                                    labels: {
                                        generateLabels: (chart) => {
                                            const chartData = chart.data;
                                            if (chartData.labels.length && chartData.datasets.length) {
                                                return chartData.labels.map((label, i) => {
                                                    const value = chartData.datasets[0].data[i];
                                                    const total = chartData.datasets[0].data.reduce((a, b) => a + b, 0);
                                                    const pct = total ? (value / total * 100) : 0;
                                                    const pctStr = pct < 10 ? pct.toFixed(1) : Math.round(pct).toString();
                                                    // Use formattedTime from original data (HH:MM format)
                                                    const formattedTime = originalData[i]?.formattedTime || formatHoursToHHMM(value);
                                                    const activityType = originalData[i]?.activityType || label.split(' (')[0];
                                                    return {
                                                        text: `${activityType} (${formattedTime}) - ${pctStr}%`,
                                                        fillStyle: chartData.datasets[0].backgroundColor[i],
                                                        hidden: false,
                                                        index: i
                                                    };
                                                });
                                            }
                                            return [];
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time Spent by Activity Type'
                                },
                                datalabels: {
                                    color: '#fff',
                                    font: { weight: 'bold' },
                                    anchor: 'center',
                                    align: 'center',
                                    clamp: true,
                                    formatter: (value, context) => {
                                        const arr = context.dataset.data;
                                        const total = arr.reduce((a, b) => a + b, 0) || 0;
                                        const pct = total ? (value / total * 100) : 0;
                                        const pctStr = pct < 10 ? pct.toFixed(1) : Math.round(pct).toString();
                                        // Prefer formatted HH:MM if available
                                        const idx = context.dataIndex;
                                        const formatted = (data && data[idx] && data[idx].formattedTime) ? data[idx].formattedTime : `${value.toFixed(1)}h`;
                                        return `${formatted} (${pctStr}%)`;
                                    },
                                    display: (context) => {
                                        const v = context.dataset.data[context.dataIndex];
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0) || 0;
                                        return total && (v / total) >= 0.05; // show if >=5% of the pie
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function loadWorkoutHeatmap() {
            const params = getDateParams();
            const heatReq = fetch('/api/stats/workout-heatmap' + params).then(r => r.json());
            const sumReq = fetch('/api/stats/workout-heatmap/summary' + params).then(r => r.json());
            Promise.all([heatReq, sumReq]).then(([heat, s]) => {
                // Counters
                const setNum = (id, val) => document.getElementById(id).innerText = (val ?? 0);
                setNum('workoutDays', s.workoutDays);
                setNum('missedDays', s.missedDays);
                setNum('currentStreak', s.currentStreak);
                setNum('daysSinceLast', s.daysSinceLast);
                setNum('longestGap', s.longestGap);
                setNum('totalGapDays', s.totalGapDays);

                // Message
                const msg = document.getElementById('consistencyMsg');
                if ((s.missedDays ?? 0) === 0) {
                    msg.className = 'text-success';
                    msg.textContent = 'No gaps ‚Äî excellent consistency!';
                    document.getElementById('showGapDetailsContainer').style.display = 'none';
                } else if ((s.currentStreak ?? 0) >= 7) {
                    msg.className = 'text-success';
                    msg.textContent = 'Great job keeping a strong streak going!';
                    document.getElementById('showGapDetailsContainer').style.display = 'block';
                } else {
                    msg.className = 'text-muted';
                    msg.textContent = 'Keep building your routine ‚Äî every day counts.';
                    document.getElementById('showGapDetailsContainer').style.display = 'block';
                }

                // Build timeline and collect gap information
                const byDate = new Map(heat.map(h => [h.date, h.value]));
                const start = s.rangeStart || (heat.length ? heat[0].date : null);
                const lastActivityDate = heat.length ? heat[heat.length - 1].date : null;
                // Render through the full requested end date for range consistency
                const end = s.rangeEnd;
                const timeline = document.getElementById('workoutTimeline');
                timeline.innerHTML = '';
                if (!start || !end) {
                    timeline.innerHTML = '<span class="text-muted">No data</span>';
                    return;
                }

                // Update date range display with actual data
                const afterInput = document.getElementById('afterDate').value;
                const beforeInput = document.getElementById('beforeDate').value;
                if (!afterInput && !beforeInput) {
                    // Set the input field values
                    document.getElementById('afterDate').value = start;
                    document.getElementById('beforeDate').value = end;

                    // Update the display
                    document.getElementById('displayStartDate').textContent = start;
                    document.getElementById('displayEndDate').textContent = end;
                    const startDate = new Date(start);
                    const endDate = new Date(end);
                    const diffTime = Math.abs(endDate - startDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    document.getElementById('displayTotalDays').textContent = diffDays;
                    document.getElementById('dateRangeDisplay').style.display = 'block';
                }

                // Parse dates and normalize to avoid timezone issues
                // Use local time to ensure we get the correct date
                const parseLocalDate = (dateStr) => {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    return new Date(year, month - 1, day);
                };
                const startDate = parseLocalDate(start);
                const endDate = parseLocalDate(end);
                let cur = new Date(startDate);
                const missedDays = [];
                
                // Iterate through all days in the range (inclusive of end date)
                // Compare dates as strings to avoid timezone issues
                const formatDate = (d) => {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                while (formatDate(cur) <= end) {
                    const key = formatDate(cur);
                    const hours = byDate.get(key) || 0;
                    const lvl = hours === 0 ? 0 : (hours < 1 ? 1 : (hours < 2 ? 2 : 3));
                    const box = document.createElement('div');
                    box.className = 'day-cell lvl-' + lvl;
                    box.title = key + (hours ? ` ‚Äî ${hours.toFixed(2)}h` : ' ‚Äî No activity');
                    timeline.appendChild(box);

                    // Collect missed days - include all days with no activity in the range
                    // This matches the backend's missedDays calculation
                    if (hours === 0) {
                        missedDays.push(key);
                    }

                    // Move to next day
                    cur.setDate(cur.getDate() + 1);
                }

                // Store missed days globally for the toggle function
                window.workoutMissedDays = missedDays;
            });
        }

        function toggleGapDetails() {
            const section = document.getElementById('gapDetailsSection');
            const toggleText = document.getElementById('gapDetailsToggleText');

            if (section.style.display === 'none') {
                // Show gap details
                const missedDays = window.workoutMissedDays || [];
                const listDiv = document.getElementById('gapDetailsList');

                if (missedDays.length === 0) {
                    listDiv.textContent = 'No missed days found.';
                } else {
                    listDiv.innerHTML = '<ul class="mb-0">' +
                        missedDays.map(day => `<li>${day}</li>`).join('') +
                        '</ul>';
                }

                section.style.display = 'block';
                toggleText.textContent = 'Hide Gap Details';
            } else {
                // Hide gap details
                section.style.display = 'none';
                toggleText.textContent = 'Show Gap Details';
            }
        }

        function loadRunStatistics() {
            fetch('/api/stats/run-statistics' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('runStatsContent');
                    container.innerHTML = `
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Total Runs</h6><h3>${data.totalRuns}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>10K+ Runs</h6><h3>${data.runs10KPlus}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Total Miles</h6><h3>${data.totalMiles}</h3></div></div></div>
                        <div class="col-md-3"><div class="card"><div class="card-body"><h6>Avg Pace</h6><h3>${data.averagePace} /mi</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Fastest Mile</h6><h3>${data.fastestMileSplit}</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Fastest 10K</h6><h3>${data.fastest10K}</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Longest Run</h6><h3>${data.longestRun} mi</h3></div></div></div>
                        <div class="col-md-3 mt-3"><div class="card"><div class="card-body"><h6>Most Elevation</h6><h3>${data.mostElevation} ft</h3></div></div></div>
                    `;
                    // Also load the run distribution chart
                    loadRunDistribution();
                });
        }

        function loadRunDistribution() {
            fetch('/api/stats/run-distribution' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('runDistributionChart').getContext('2d');
                    if (runDistributionChart) runDistributionChart.destroy();
                    runDistributionChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(d => d.distanceRange),
                            datasets: [{
                                label: 'Number of Runs',
                                data: data.map(d => d.count),
                                backgroundColor: 'rgba(75, 112, 235, 0.8)',
                                borderColor: 'rgba(75, 112, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                datalabels: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    title: {
                                        display: true,
                                        text: 'Number of Runs'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Distance Range (miles)'
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function loadRunningHeatmap() {
            fetch('/api/stats/running-heatmap' + getDateParams())
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('runningHeatmap');
                    container.innerHTML = '';

                    // Helper function to format date as YYYY-MM-DD in local timezone
                    function formatLocalDate(date) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }

                    // Helper function to create date from YYYY-MM-DD string in local timezone
                    function parseLocalDate(dateStr) {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        return new Date(year, month - 1, day);
                    }

                    // Get the actual filter date range
                    const afterInput = document.getElementById('afterDate').value;
                    const beforeInput = document.getElementById('beforeDate').value;
                    
                    // Determine the range: use filter dates if provided, otherwise use data range
                    let startDate, endDate;
                    if (afterInput && beforeInput) {
                        startDate = parseLocalDate(afterInput);
                        endDate = parseLocalDate(beforeInput);
                    } else if (data && data.length > 0) {
                        const dates = data.map(d => parseLocalDate(d.date));
                        startDate = new Date(Math.min(...dates));
                        endDate = new Date(Math.max(...dates));
                    } else {
                        container.innerHTML = '<span class="text-muted">No running data</span>';
                        return;
                    }

                    // Create a map of date to miles
                    const byDate = new Map(data.map(h => [h.date, h.value]));

                    // Calculate statistics
                    let runningDays = 0;
                    let nonRunningDays = 0;
                    let currentStreak = 0;
                    let longestGap = 0;
                    let currentGap = 0;

                    // Build all dates in the range
                    let cur = new Date(startDate);
                    const allDates = [];
                    const endDateStr = formatLocalDate(endDate);
                    while (true) {
                        const curDateStr = formatLocalDate(cur);
                        allDates.push(curDateStr);
                        if (curDateStr === endDateStr) break;
                        cur.setDate(cur.getDate() + 1);
                    }

                    // Calculate current streak from end date backwards
                    for (let i = allDates.length - 1; i >= 0; i--) {
                        const key = allDates[i];
                        const miles = byDate.get(key) || 0;
                        if (miles > 0) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }

                    // Build timeline and calculate stats over the full range
                    cur = new Date(startDate);
                    while (true) {
                        const key = formatLocalDate(cur);
                        const miles = byDate.get(key) || 0;
                        const lvl = miles === 0 ? 0 : (miles < 3 ? 1 : (miles < 6 ? 2 : (miles < 10 ? 3 : 4)));
                        const box = document.createElement('div');
                        box.className = 'day-cell lvl-' + lvl;
                        box.title = key + (miles ? ` ‚Äî ${miles.toFixed(2)} mi` : ' ‚Äî No run');
                        container.appendChild(box);

                        // Count running vs non-running days
                        if (miles > 0) {
                            runningDays++;
                            currentGap = 0;
                        } else {
                            nonRunningDays++;
                            currentGap++;
                            if (currentGap > longestGap) {
                                longestGap = currentGap;
                            }
                        }

                        if (key === endDateStr) break;
                        cur.setDate(cur.getDate() + 1);
                    }

                    // Update statistics display
                    document.getElementById('runningDays').textContent = runningDays;
                    document.getElementById('nonRunningDays').textContent = nonRunningDays;
                    document.getElementById('currentRunStreak').textContent = currentStreak;
                    document.getElementById('longestRunGap').textContent = longestGap;
                });
        }

        function loadMileageTrend(period) {
            fetch('/api/stats/mileage-trend' + getDateParams() + (getDateParams() ? '&' : '?') + 'period=' + period)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('mileageTrendChart').getContext('2d');
                    if (mileageTrendChart) mileageTrendChart.destroy();
                    mileageTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.label),
                            datasets: [{
                                label: 'Miles',
                                data: data.map(d => d.value),
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                datalabels: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' mi';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Miles'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function loadPaceTrend(period) {
            fetch('/api/stats/pace-trend' + getDateParams() + (getDateParams() ? '&' : '?') + 'period=' + period)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('paceTrendChart').getContext('2d');
                    if (paceTrendChart) paceTrendChart.destroy();
                    paceTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.label),
                            datasets: [{
                                label: 'Pace',
                                data: data.map(d => d.value),
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                datalabels: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const mins = Math.floor(context.parsed.y / 60);
                                            const secs = Math.floor(context.parsed.y % 60);
                                            return 'Pace: ' + mins + ':' + (secs < 10 ? '0' : '') + secs + ' /mi';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'Pace (min/mile)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            const mins = Math.floor(value / 60);
                                            const secs = Math.floor(value % 60);
                                            return mins + ':' + (secs < 10 ? '0' : '') + secs;
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function setDateRange(days) {
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];

            if (days === 0) {
                // All time - clear dates to show all data
                document.getElementById('afterDate').value = '';
                document.getElementById('beforeDate').value = '';
            } else {
                // Set start date to 'days' ago
                const startDate = new Date(today);
                startDate.setDate(startDate.getDate() - days);
                document.getElementById('afterDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('beforeDate').value = endDate;
            }

            // Apply the filter
            loadAllData();
        }

        function setDateRangeYTD() {
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];
            // Set start date to January 1st of the current year (format as YYYY-MM-DD to avoid timezone issues)
            const year = today.getFullYear();
            const startDate = `${year}-01-01`;
            document.getElementById('afterDate').value = startDate;
            document.getElementById('beforeDate').value = endDate;
            // Apply the filter
            loadAllData();
        }

        function updateDateRangeDisplay() {
            const after = document.getElementById('afterDate').value;
            const before = document.getElementById('beforeDate').value;
            const display = document.getElementById('dateRangeDisplay');

            if (after || before) {
                const startDate = after || '(earliest activity)';
                const endDate = before || '(latest activity)';

                document.getElementById('displayStartDate').textContent = startDate;
                document.getElementById('displayEndDate').textContent = endDate;

                // Calculate days if both dates are provided
                if (after && before) {
                    const start = new Date(after);
                    const end = new Date(before);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    document.getElementById('displayTotalDays').textContent = diffDays;
                } else {
                    document.getElementById('displayTotalDays').textContent = 'N/A';
                }

                display.style.display = 'block';
            } else {
                display.style.display = 'none';
            }
        }

        function loadAllData() {
            updateDateRangeDisplay();
            loadActivityCount();
            loadTimeDistribution();
            loadWorkoutHeatmap();
            loadRunStatistics(); // This also loads run distribution
            loadRunningHeatmap();
            loadMileageTrend('daily');
            loadPaceTrend('daily');
        }

        function generateColors(count) {
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            return colors.slice(0, count);
        }

        function formatHoursToHHMM(hours) {
            const totalMinutes = Math.round(hours * 60);
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // Load data on page load with default 30 days
        window.addEventListener('load', function() {
            setDateRange(30); // Default to last 30 days
        });
    </script>
</body>
</html>
